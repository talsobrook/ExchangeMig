# Connect to Exchange Online
Connect-ExchangeOnline

# Set domain to filter
$filterDomain = "@yourdomain.com"

# Output CSV path
$outputPath = "C:\Export\FilteredProxyAddresses.csv"

# Collect mailboxes
$mailboxes = Get-Mailbox -ResultSize Unlimited
$sharedMailboxes = Get-Mailbox -ResultSize Unlimited -RecipientTypeDetails SharedMailbox
$mailUsers = Get-MailUser -ResultSize Unlimited

# Combine all
$allRecipients = @()
$allRecipients += $mailboxes
$allRecipients += $sharedMailboxes
$allRecipients += $mailUsers

# Filter and collect results
$filteredResults = foreach ($recipient in $allRecipients) {
    $matchingProxies = $recipient.EmailAddresses | Where-Object { $_ -like "*$filterDomain*" }

    if ($matchingProxies) {
        [PSCustomObject]@{
            DisplayName       = $recipient.DisplayName
            PrimarySMTP       = ($recipient.PrimarySmtpAddress).ToString()
            RecipientType     = $recipient.RecipientTypeDetails
            UserPrincipalName = $recipient.UserPrincipalName
            ProxyAddresses    = ($matchingProxies -join "; ")
        }
    }
}

# Export to CSV
$filteredResults | Export-Csv -Path $outputPath -NoTypeInformation -Encoding UTF8

Write-Host "`nâœ… Export complete: $outputPath"
